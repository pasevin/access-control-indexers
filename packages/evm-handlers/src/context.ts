/**
 * Handler Context Management
 *
 * This module provides a clean way to initialize the shared handlers with
 * network-specific configuration and SubQuery-generated entities.
 *
 * Usage in each network's index.ts:
 *
 * ```typescript
 * import { initializeHandlers } from '@oz-indexers/evm-handlers';
 * import { AccessControlEvent, RoleMembership, ContractOwnership, Contract } from './types';
 *
 * initializeHandlers({
 *   networkId: 'ethereum-mainnet',
 *   entities: { AccessControlEvent, RoleMembership, ContractOwnership, Contract },
 *   store,  // SubQuery provides this global
 * });
 *
 * export { handleRoleGranted, ... } from '@oz-indexers/evm-handlers';
 * ```
 */

import type {
  HandlerContext,
  AccessControlEventEntity,
  RoleMembershipEntity,
  ContractOwnershipEntity,
  ContractEntity,
  Store,
} from './types';

// The global context, initialized by each network
let context: HandlerContext | null = null;

/**
 * Configuration for initializing the handlers
 */
export interface InitConfig {
  /** Network identifier (e.g., 'ethereum-mainnet') */
  networkId: string;
  /** Entity classes generated by SubQuery codegen */
  entities: {
    AccessControlEvent: AccessControlEventEntity;
    RoleMembership: RoleMembershipEntity;
    ContractOwnership: ContractOwnershipEntity;
    Contract: ContractEntity;
  };
  /** SubQuery store (provided as global by SubQuery runtime) */
  store: Store;
}

/**
 * Initialize the shared handlers with network-specific configuration.
 * Must be called before any handlers are invoked.
 *
 * @param config - Network configuration and entities
 */
export function initializeHandlers(config: InitConfig): void {
  context = {
    networkId: config.networkId,
    entities: config.entities,
    store: config.store,
  };

  // Also set up legacy globals for backward compatibility
  (globalThis as any).NETWORK_ID = config.networkId;
  (globalThis as any).AccessControlEvent = config.entities.AccessControlEvent;
  (globalThis as any).RoleMembership = config.entities.RoleMembership;
  (globalThis as any).ContractOwnership = config.entities.ContractOwnership;
  (globalThis as any).Contract = config.entities.Contract;
}

/**
 * Get the current handler context.
 * Throws if handlers haven't been initialized.
 */
export function getContext(): HandlerContext {
  if (!context) {
    throw new Error(
      'Handlers not initialized. Call initializeHandlers() before using handlers.'
    );
  }
  return context;
}

/**
 * Get the network ID for the current context.
 */
export function getNetworkId(): string {
  return getContext().networkId;
}

/**
 * Get the entity classes for the current context.
 */
export function getEntities(): HandlerContext['entities'] {
  return getContext().entities;
}

/**
 * Get the store for the current context.
 */
export function getStore(): Store {
  return getContext().store;
}
